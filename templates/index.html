{% extends "page.html" %}
{% block main %}

<div class="container">

  <!-- Title -->  
  <div class="row">
    <div class="col-md-offset-2 col-md-8">
      <div class="text-center title">
        <h2 id="title">JupyterHub Entrypoint Service</h2>
        <h5>Launch Jupyter notebook servers in custom environments</h5>
      </div>
    </div>
  </div>

  <!-- Buttons to switch tags -->
  <div class="row">
    <div class="col-md-offset-2 col-md-8">
      <div class="text-center">
        <div class="btn-group" role="group">
          {% for tag in tags %}
          {% if tag.tag_name == tag_name %}
          <a class="btn btn-default active" href="#" role="button">{{tag.display_name}}</a>
          {% else %}
          <a class="btn btn-default" href="{{service_prefix}}{{tag.tag_name}}" role="button">{{tag.display_name}}</a>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- displays current entrypoint, modified by script block -->
  <div class="row">
    <div class="col-md-offset-2 col-md-8">
      <dl>
        <dt>Selected entrypoint for {{tag_name}}:</dt>
        <dd id="current-entrypoint">
        {% if selection %}
          {{selection.entrypoint_data.entrypoint_name}} ({{selection.entrypoint_data.entrypoint_type}})
        {% else %}
          <em>None</em>
        {% endif %}
        </dd>
        <form id="clear-selection">
          {% if selection %}
          <button id="clear-selection-button" type="submit" class="btn btn-jupyter clear-button">
          {% else %}
          <button id="clear-selection-button" type="submit" class="btn btn-jupyter clear-button" disabled>
          {% endif %}
            Clear current entrypoint
          </button>
        </form>
      </dl>
    </div>
  </div>

  <!-- row for managing each entrypoint type -->
  {% for entrypoint_type in entrypoint_types %}
  {% set type_name = entrypoint_type.type_name %}
  {% set display_name = entrypoint_type.display_name %}
  <div class="row">
    <div class="update-entrypoint col-md-offset-2 col-md-8">
      <h4>Manage {{display_name}} entrypoints</h4>
      <div class="form-group">
        <div class="input-group">

          <!-- dropdown to select entrypoint to manipulate -->
          <select id="{{type_name}}" name="{{type_name}}" class="form-control">
            <option disabled selected value>
                -- select or manage an entrypoint --
            </option>
            {% for entrypoint in entrypoints[type_name] %}
            <option>{{entrypoint.entrypoint_data.entrypoint_name}}</option>
            {% endfor %}
          </select>

          <!-- select, delete, add entrypoints -->
          <span class="input-group-btn">
            <button id="select-{{type_name}}-button" type="button" onclick="selectHandler('{{type_name}}')"
                class="row-button btn btn-jupyter">select</button>
            <button id="add-{{type_name}}-button" type="button" class="row-button btn btn-jupyter" data-toggle="modal"
                data-target="#add-{{type_name}}-modal">
                add
            </button>
            <button id="delete-{{type_name}}-button" type="button" onclick="deleteHandler('{{type_name}}')" class="row-button btn btn-jupyter">
                delete
            </button>

          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- tag should be a thing so we can get its display name -->
  <!-- type should in some places be a display name -->
  <!-- modal for adding entrypoints -->
  <div class="modal fade" id="add-{{type_name}}-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <!-- modal header: title -->
        <div class="modal-header">
          <h4 class="modal-title" id="add-{{type_name}}-modal-title">
            Add a new {{display_name}} entrypoint for {{tag_name}}
          </h4>
        </div>

        <!-- modal body: input, select for entrypoint data; tag checkboxes -->
        <div class="modal-body">
          <div id="add-{{type_name}}" class="add-entrypoint col-md-offset-2 col-md-8">
            <div class="form-group">
              <div class="input-group" id="testing-{{type_name}}">

                <!-- input, select elements for entrypoint data -->
                {{ entrypoint_type.form() }}

                <!-- checkboxes for tagging -->
                <p class="no-margin form-text"><b>Additional tags:</b></p>
                {% for tag in tags %}
                {% if tag.tag_name != tag_name %}
                <input type="checkbox" class="tag-checkbox" value="{{tag.tag_name}}">
                <label class="checkbox-label" for="{{tag.tag_name}}">
                  {{tag.display_name}}
                </label>
                {% endif %}
                {% endfor %}
              </div>
            </div>
            <!-- where to show messages if necessary -->
            <div>
              <small id="{{type_name}}-error-msg" class="form-text text-muted error note"></small>
              <small id="{{type_name}}-msg" class="form-text text-muted note"></small>
            </div>
          </div>
        </div>

        <!-- modal footer: cancel and add buttons -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="addHandler('{{type_name}}')">
              Add entrypoint
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<style scoped>
    .row-button {
        margin-left: 4px !important;
    }

    .form-group {
        margin-bottom: 10px;
    }

    a {
        text-decoration: underline;
        color: black;
    }

    .clear-button {
        margin-top: 10px;
    }

    /* Style the tab */
    .selection-buttons {
        padding: 10px !important;
        min-width: 85px;
    }

    .systems-tab-title {
        background-color: rgb(133, 133, 133);
        color: white;
    }

    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        margin-bottom: 20px;
    }

    /* Style the buttons that are used to open the tab content */
    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
    }

    .tab p {
        margin: 0;
        float: left;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
    }

    /* Change background color of buttons on hover */
    .tab button:hover {
        background-color: #ddd;
    }

    /* Create an active/current tablink class */
    .tab button.active {
        background-color: #ccc;
    }

    dl {
        margin-bottom: 0px;
    }

    .title {
        margin-bottom: 40px;
    }

    .modal-body {
        min-height: 190px;
    }

    .checkbox-label {
        margin: 0px 30px 0px 5px;
    }

    .no-margin {
        margin: 0px;
    }

    .error {
        color: rgba(255, 0, 0, 0.788);
    }

    .row {
        max-width: 900px;
        margin: auto;
    }

    .container {
        padding-bottom: 40px;
    }

    h4 {
        margin-top: 40px;
    }

    .btn {
        min-width: 72px;
    }

    .input-group .small-form {
        position: relative;
        z-index: 2;
        float: left;
        margin-bottom: 10px;
    }

    .input-group {
        margin-bottom: 0px;
    }

    .note {
        padding-left: 3px;
    }
</style>

<script type="text/javascript">

// Delete user entrypoint selection and reload

$("#clear-selection").submit(function (event) {
    event.preventDefault();
    $.ajax({
        method: "DELETE",
        url: `/services/entrypoint/api/mgmt/users/{{user.name}}/selections/{{selection.entrypoint_name}}/tags/{{tag_name}}`,
        data: JSON.stringify({}),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
    }).always(function () {
        location.reload(true);
    });
});

// Collect user entrypoint name and call selectEntrypoint()

async function selectHandler(entrypoint_type) {
    const entrypoint_name = $(`#${entrypoint_type}`).val();
    if (entrypoint_name !== null) {
        const result = await selectEntrypoint(entrypoint_name);
        location.reload()
    }
}

// Select user entrypoint for use by the hub at spawner start

async function selectEntrypoint(entrypoint_name) {
    const response = await $.ajax({
        method: "PUT",
        url: `/services/entrypoint/api/mgmt/users/{{user.name}}/selections/${entrypoint_name}/tags/{{tag_name}}`,
        data: JSON.stringify({}),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
    });
    return response.result;
}

// Collect user entrypoint name and call deleteEntrypoint()

async function deleteHandler(entrypoint_type) {
    const entrypoint_name = $(`#${entrypoint_type}`).val();
    if (entrypoint_name !== null) {
        if (confirm(`Are you sure you want to delete entrypoint "${entrypoint_name}"?\nThis will remove it for all tags.`)) {
            const result = await deleteEntrypoint(entrypoint_name);
            location.reload();
        }
    }
}

// Delete user entrypoint

async function deleteEntrypoint(entrypoint_name) {
    const response = await $.ajax({
        method: "DELETE",
        url: `/services/entrypoint/api/mgmt/users/{{user.name}}/entrypoints/${entrypoint_name}`,
        data: JSON.stringify({}),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
    });
    return response.result;
}

// Collect new user entrypoint data and call addEntrypoint()

async function addHandler(entrypoint_type) {

    let entrypoint_data = {
        user: "{{user.name}}",
        entrypoint_type: entrypoint_type,
    };

    let tag_names = ["{{tag_name}}"];

    $(`#testing-${entrypoint_type} :input`).each(function(index) {
        if ($(this).hasClass("tag-checkbox")) {
            if ($(this).prop("checked")) tag_names.push($(this).val());
        }
        else {
            var name = $(this).attr("name");
            var value = $(this).val();
            entrypoint_data[name] = value;
        }
    });

    result = await addEntrypoint(entrypoint_data, tag_names);

    if (!result.result) {
        $(`#${entrypoint_type}-error-msg`).html(result.message);
    } else {
        location.reload();
    }
}

// Add user entrypoint

async function addEntrypoint(entrypoint_data, tag_names) {
    const payload = {
        entrypoint_data: entrypoint_data,
        tag_names: tag_names
    };
    const response = await $.ajax({
        method: "POST",
        url: "/services/entrypoint/api/mgmt/users/{{user.name}}/entrypoints/",
        data: JSON.stringify(payload),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
    });

    return response;
}

</script>
{% endblock %}
